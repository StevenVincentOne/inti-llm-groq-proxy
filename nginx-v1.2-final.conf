events {
    worker_connections 1024;
}

http {
    # IPv4-only DNS resolution to prevent IPv6 connection failures  
    resolver 1.1.1.1 8.8.8.8 ipv6=off valid=300s;
    
    server {
        listen 8000;
        
        # Access logs
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;
        
        # Health check endpoint
        location = /api/build_info {
            return 200 '{"status": "ok", "service": "llm-groq-proxy", "version": "v1.2-final"}';
            add_header Content-Type application/json;
        }
        
        # Health check for vllm compatibility
        location = /health {
            return 200 '{"status": "ok"}';
            add_header Content-Type application/json;
        }
        
        # Models endpoint with IPv6 fixes
        location = /models {
            proxy_pass https://api.groq.com/openai/v1/models;
            proxy_set_header Authorization "Bearer ${GROQ_API_KEY}";
            proxy_set_header Content-Type application/json;
            proxy_set_header Host api.groq.com;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
        
        # Chat completions endpoint - optimized for gpt-oss-20b
        location = /chat/completions {
            proxy_pass https://api.groq.com/openai/v1/chat/completions;
            proxy_set_header Authorization "Bearer ${GROQ_API_KEY}";
            proxy_set_header Content-Type application/json;
            proxy_set_header Host api.groq.com;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 4k;
        }
        
        # Catch-all for other OpenAI-compatible endpoints
        location / {
            proxy_pass https://api.groq.com/openai/v1/;
            proxy_set_header Authorization "Bearer ${GROQ_API_KEY}";
            proxy_set_header Content-Type application/json;
            proxy_set_header Host api.groq.com;
            proxy_ssl_server_name on;
            proxy_ssl_verify off;
            proxy_connect_timeout 30s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
        }
    }
}